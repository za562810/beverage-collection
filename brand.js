const items1 = [
  {
    name: "冰糖洛神梅",
    price: "45",
    thumb: 0,
  },
  {
    name: "香柚綠茶",
    price: "55",
    thumb: 1,
  },
  {
    name: "養樂多綠",
    price: "50",
    thumb: 0,
  },
  {
    name: "青檸香茶",
    price: "65",
    thumb: 1,
  },
  {
    name: "冬瓜青茶",
    price: "50",
    thumb: 0,
  },
  {
    name: "冬瓜麥茶",
    price: "45",
    thumb: 0,
  },
  {
    name: "冬瓜檸檬",
    price: "45",
    thumb: 0,
  },
  {
    name: "柳丁綠茶/青茶",
    price: "60",
    thumb: 1,
  },
  {
    name: "冰萃柳丁",
    price: "60",
    thumb: 0,
  },
  {
    name: "冰萃檸檬",
    price: "55",
    thumb: 0,
  },
  {
    name: "白甘蔗青茶",
    price: "65",
    thumb: 0,
  },
  {
    name: "蜂蜜檸檬晶凍",
    price: "55",
    thumb: 0,
  },
];
const items2 = [
  {
    name: "珍珠大正紅茶拿鐵",
    price: "55",
    thumb: 1,
  },
  {
    name: "珍珠手炒黑糖鮮奶",
    price: "75",
    thumb: 0,
  },
  {
    name: "仙草凍冬瓜茶",
    price: "40",
    thumb: 0,
  },
  {
    name: "蜜Q茉香拿鐵",
    price: "80",
    thumb: 0,
  },
  {
    name: "蜜Q大麥拿鐵",
    price: "80",
    thumb: 0,
  },
  {
    name: "檸檬蜜Q晶凍",
    price: "70",
    thumb: 1,
  },
  {
    name: "柚蜜白玉",
    price: "65",
    thumb: 0,
  },
];
const items3 = [
  {
    name: "伯爵紅茶拿鐵",
    price: "45 / 55",
    thumb: 1,
  },
  {
    name: "大正紅茶拿鐵",
    price: "45 / 55",
    thumb: 1,
  },
  {
    name: "原片青茶拿鐵",
    price: "45 / 55",
    thumb: 0,
  },
  {
    name: "琥珀烏龍拿鐵",
    price: "45 / 55",
    thumb: 0,
  },
  {
    name: "茉香綠茶拿鐵",
    price: "45 / 55",
    thumb: 0,
  },
  {
    name: "焙香大麥拿鐵",
    price: "45 / 55",
    thumb: 0,
  },
  {
    name: "娜杯紅茶拿鐵",
    price: "45 / 55",
    thumb: 1,
  },
  {
    name: "布朗紅茶拿鐵",
    price: "60 / 70",
    thumb: 0,
  },
  {
    name: "伯爵可可拿鐵",
    price: "60 / 70",
    thumb: 0,
  },
  {
    name: "蜂蜜綠茶拿鐵",
    price: "65 / 75",
    thumb: 0,
  },
  {
    name: "蜂蜜麥茶拿鐵",
    price: "65 / 75",
    thumb: 0,
  },
];
const items4 = [
  {
    name: "英倫伯爵紅茶",
    price: "30",
    thumb: 0,
  },
  {
    name: "大正醇香紅茶",
    price: "30",
    thumb: 0,
  },
  {
    name: "原片初露青茶",
    price: "30",
    thumb: 0,
  },
  {
    name: "琥珀高峰烏龍",
    price: "30",
    thumb: 0,
  },
  {
    name: "茉莉原淬綠茶",
    price: "30",
    thumb: 0,
  },
  {
    name: "焙香決明大麥",
    price: "30",
    thumb: 0,
  },
  {
    name: "原鄉冬瓜茶",
    price: "30",
    thumb: 0,
  },
  {
    name: "娜杯紅茶",
    price: "30",
    thumb: 1,
  },
];
const items5 = [
  {
    name: "珍珠鮮奶",
    price: "65 / 85",
    thumb: 0,
  },
  {
    name: "芋頭鮮奶",
    price: "65 / 85",
    thumb: 1,
  },
  {
    name: "嫩仙草凍奶",
    price: "65 / 85",
    thumb: 1,
  },
  {
    name: "手炒黑糖鮮奶",
    price: "65 / 85",
    thumb: 1,
  },
  {
    name: "法芙娜純可可鮮奶",
    price: "65 / 85",
    thumb: 0,
  },
];
const items6 = [
  {
    name: "伯爵紅茶鮮豆奶",
    price: "55",
    thumb: 0,
  },
  {
    name: "醇濃紅茶鮮豆奶",
    price: "55",
    thumb: 0,
  },
  {
    name: "原片青茶鮮豆奶",
    price: "55",
    thumb: 0,
  },
  {
    name: "琥珀烏龍鮮豆奶",
    price: "55",
    thumb: 0,
  },
  {
    name: "茉香綠茶鮮豆奶",
    price: "55",
    thumb: 0,
  },
  {
    name: "焙香決明大麥鮮豆奶",
    price: "55",
    thumb: 0,
  },
  {
    name: "娜杯紅茶鮮豆奶",
    price: "55",
    thumb: 0,
  },
];

const itemGroup = [
  {
    title: "手作特調",
    group: items1,
  },
  {
    title: "嚼對推薦",
    group: items2,
  },
  {
    title: "牧場鮮奶茶",
    group: items3,
  },
  {
    title: "愛茶的牛",
    group: items4,
  },
  {
    title: "綠光牧場鮮奶",
    group: items5,
  },
  {
    title: "台灣鮮豆奶",
    group: items6,
  },
];

//進來就檢查是否有收藏該品牌
window.onload = function checkSave() {
  const save = JSON.parse(localStorage.getItem("save")) || [];
  if (save === document.querySelector("h1").innerHTML) {
    document.querySelector(".heart").style.fontVariationSettings = `"FILL" 1`;
  }
};

//
//產生平均分數存入item1-6物件
function generateAverageScore() {
  const historys = JSON.parse(localStorage.getItem("record")) || [];
  //取出item與rating存進新陣列
  const scorePair = historys.map((record) => {
    return {
      item: record.item,
      rating: record.rating,
    };
  });

  //將陣列針對item累加總分跟次數
  const result = scorePair.reduce((accumulator, obj) => {
    //如果目前沒有該item，則加上
    if (!accumulator[obj.item]) {
      accumulator[obj.item] = { sum: 0, count: 0 };
    }
    accumulator[obj.item].sum += parseInt(obj.rating);
    accumulator[obj.item].count++;
    return accumulator;
  }, {});

  const averageRatings = {};
  for (const item in result) {
    averageRatings[item] = parseFloat(
      (result[item].sum / result[item].count).toFixed(1)
    );
  }
  for (const group of itemGroup) {
    for (const item of group.group) {
      item.score = averageRatings[item.name] || "-";
    }
  }
}
generateAverageScore();

//
//產生menuGroup
let menuGroup = document.querySelector(".menuGroup");
function generateMGHTML(target) {
  return target
    .map((itemGroup) => {
      return `<section class="menu"><h3 class="category">${itemGroup.title}</h3>
      <ul class="menuList"></ul></section>`;
    })
    .join(""); //將新陣列轉為字串
}
menuGroup.innerHTML = generateMGHTML(itemGroup);

//產生items
function generateItems() {
  function generateItemHTML(target) {
    return target
      .map((item) => {
        const thumbHTML =
          item.thumb === 1
            ? '<span class="material-symbols-rounded thumb"> thumb_up </span>'
            : "";
        return `
          <li class="updateDetails">
            <div class="itemL">
              <h6>${item.name}</h6>
              ${thumbHTML}
            </div>
  
            <div class="itemR">
              <span class="price">${item.price}</span>
              <span>|</span>
              <div class="average">
              <span class="material-symbols-rounded star">
                star</span>
                <span id="averageScore">${item.score}</span>
            </div>
            </div>
          </li>`;
      })
      .join("");
  }
  let menuLists = document.querySelectorAll(".menuList");

  //迴圈將產生的HTML放入group
  itemGroup.forEach((group, index) => {
    let menuList = menuLists[index];
    menuList.innerHTML = generateItemHTML(group.group);
  });
}
generateItems();

//
//item如果有紀錄會變成var(--secondary-color)
function checkHasItem() {
  const historys = JSON.parse(localStorage.getItem("record")) || []; //取得record
  const targetItem = document.querySelectorAll("h6");
  for (let i = 0; i < targetItem.length; i++) {
    const hasItem = historys.some((e) => {
      return e.item == targetItem[i].textContent; //巢狀迴圈
    });
    if (hasItem) {
      targetItem[i].style.color = "var(--darkSecondary-color)";
      targetItem[i].style.fontWeight = "bold";
    }
  }
}
checkHasItem();

//
//顯示dialog
const updateButton = document.querySelectorAll(".updateDetails");
const favDialog = document.getElementById("favDialog");
const myForm = document.getElementById("myForm");
const confirmBtn = favDialog.querySelector("#confirmBtn");
const cancelBtn = favDialog.querySelector(".cancel");

//dialog帶入brand, item, price
const brandArea = document.getElementById("inpBrand"); //取得要放html的位子
const itemArea = document.getElementById("inpItem"); //取得要放html的位子
const priceArea = document.getElementById("inpPrice"); //取得要放html的位子
const brandTitle = document.querySelector(".brandDesc");
const brandName = brandTitle.querySelector("h1").textContent;

//點擊list帶入資料
updateButton.forEach((e) => {
  e.addEventListener("click", (e) => {
    favDialog.showModal();
    document.body.style.overflow = "hidden";
    favDialog.scrollTop = 0;

    //預設帶入當下時間
    const currentDate = new Date();
    const dateInput = document.getElementById("inpDate");
    const timeInput = document.getElementById("inpTime");

    // 設定日期輸入框的值
    const year = currentDate.getFullYear();
    const month = String(currentDate.getMonth() + 1).padStart(2, "0");
    const day = String(currentDate.getDate()).padStart(2, "0");
    dateInput.value = `${year}-${month}-${day}`;

    // 設定時間輸入框的值
    const hours = String(currentDate.getHours()).padStart(2, "0");
    const minutes = String(currentDate.getMinutes()).padStart(2, "0");
    timeInput.value = `${hours}:${minutes}`;

    const itemName = e.currentTarget.querySelector("h6").textContent;
    itemArea.value = itemName;

    const itemPrice = e.currentTarget.querySelector(".price").textContent;
    priceArea.value = itemPrice;
    brandArea.value = brandName;
  });
});

//
//rating
function activateRating() {
  const ratingStars = myForm.querySelectorAll(".star");
  const ratingInput = document.getElementById("rating");
  ratingStars.forEach((star) => {
    star.addEventListener("click", (e) => {
      const selectedRating = e.target.getAttribute("data-rating");
      ratingInput.value = selectedRating;

      // 移除所有星星的 active class
      ratingStars.forEach((star) => {
        star.classList.remove("active");
      });

      // 將選取的星星以及之前的星星加上 active class
      for (let i = 0; i < selectedRating; i++) {
        ratingStars[i].classList.add("active");
      }
    });
  });
}
activateRating();

//
//上傳圖片
const fileUploader = document.getElementById("file-uploader");
let fileData;

function imgUpload(e) {
  const previewImage = document.getElementById("preview-image");
  const uploadArea = document.querySelector(".upload");

  const file = e.target.files[0]; //取得name

  //將文件轉換為 Data URL
  const reader = new FileReader();
  reader.readAsDataURL(file);

  reader.addEventListener("load", function () {
    //預覽圖片
    previewImage.src = reader.result;
    previewImage.style.display = "block";
    uploadArea.style.backgroundColor = "black";

    //將圖片數據存入 fileData
    fileData = {
      name: file.name,
      type: file.type,
      size: file.size,
      dataURL: reader.result,
    };
  });
}
fileUploader.addEventListener("change", imgUpload);

//
//提交表單的處理
myForm.addEventListener("submit", (e) => {
  e.preventDefault();

  //從表單中獲取值
  const brand = document.getElementById("inpBrand").value;
  const item = document.getElementById("inpItem").value;
  const size = document.getElementById("inpSize").value;
  const price = document.getElementById("inpPrice").value;
  const date = document.getElementById("inpDate").value;
  const time = document.getElementById("inpTime").value;
  const sugar = document.querySelector('input[name="sugar"]:checked').value;
  const ice = document.querySelector('input[name="ice"]:checked').value;
  const note = document.getElementById("inpNote").value;
  const rating = document.getElementById("rating").value;
  const image = fileData || [];
  let id = new Date();

  const existed = JSON.parse(localStorage.getItem("record")) || [];

  // 儲存到 LocalStorage
  const record = {
    id,
    brand,
    item,
    size,
    price,
    date,
    time,
    sugar,
    ice,
    rating,
    note,
    image,
  };

  if (existed !== null) {
    existed.push(record);
    localStorage.setItem("record", JSON.stringify(existed));
  } else {
    let newArr = [record];
    localStorage.setItem("record", JSON.stringify(newArr));
  }

  resetFrom();

  generateAverageScore();
  const averageScoreElements = document.querySelectorAll("#averageScore");
  averageScoreElements.forEach((element) => {
    const itemName =
      element.parentNode.parentNode.parentNode.querySelector("h6").textContent;
    const item = itemGroup
      .flatMap((group) => group.group)
      .find((item) => item.name === itemName);
    element.textContent = item.score || "-";
  });

  //顯示新存取的收集結果
  checkHasItem();

  // 顯示成功訊息
  const snackbar = document.querySelector(".snackbar");
  setTimeout(() => {
    snackbar.style.display = "block";
  }, 10);
  setTimeout(() => {
    snackbar.style.display = "none";
  }, 2000);
});

//不儲存form時關閉則重設表單
function resetFrom() {
  favDialog.close();
  document.body.style.overflow = "auto";
  const ratingInput = document.getElementById("rating");
  ratingInput.value = "";
  const ratingStars = myForm.querySelectorAll(".star");
  ratingStars.forEach((star) => {
    star.classList.remove("active");
  });
  const previewImage = document.getElementById("preview-image");
  const uploadArea = document.querySelector(".upload");
  previewImage.style.display = "none";
  uploadArea.style.backgroundColor = "var(--grey100)";
  myForm.reset();
  fileData = [];
}

cancelBtn.addEventListener("click", resetFrom);
//點擊外部關閉
window.onclick = function (e) {
  if (e.target == favDialog) {
    resetFrom();
  }
};

//
//收藏品牌toggle並存入local storage
function fillIcon(e) {
  if (e.style.fontVariationSettings === "") {
    e.style.fontVariationSettings = `"FILL" 1`;
    localStorage.setItem("save", JSON.stringify(brandName));
    const snackbar = document.querySelector(".snackbar.marked");
    setTimeout(() => {
      snackbar.style.display = "block";
    }, 10);
    setTimeout(() => {
      snackbar.style.display = "none";
    }, 2000);
  } else {
    e.style.fontVariationSettings = "";
    localStorage.removeItem("save");
    const snackbar = document.querySelector(".snackbar.unmarked");
    setTimeout(() => {
      snackbar.style.display = "block";
    }, 10);
    setTimeout(() => {
      snackbar.style.display = "none";
    }, 2000);
  }
}
